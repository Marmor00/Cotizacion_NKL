<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>Generar Nota de Venta</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1b5e20 0%, #4caf50 100%);
        padding: 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 28px;
        margin-bottom: 8px;
        font-weight: 600;
      }

      .header p {
        font-size: 14px;
        opacity: 0.95;
      }

      .content {
        padding: 30px;
      }

      .section {
        margin-bottom: 30px;
      }

      .section-title {
        font-size: 16px;
        font-weight: 600;
        color: #1b5e20;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #4caf50;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        font-weight: 500;
        margin-bottom: 6px;
        color: #333;
        font-size: 14px;
      }

      input[type="text"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.3s ease;
        font-family: inherit;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #4caf50;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
      }

      textarea {
        resize: vertical;
        min-height: 80px;
      }

      .radio-group {
        display: flex;
        gap: 20px;
        margin-top: 10px;
      }

      .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .radio-option input[type="radio"] {
        width: auto;
        cursor: pointer;
      }

      .productos-container {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        background: #f9f9f9;
        max-height: 400px;
        overflow-y: auto;
      }

      .producto-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
      }

      .producto-item h4 {
        color: #1b5e20;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .producto-details {
        font-size: 13px;
        color: #666;
        line-height: 1.6;
      }

      .buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
      }

      .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }

      .btn-primary {
        background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(27, 94, 32, 0.3);
      }

      .btn-primary:active {
        transform: translateY(0);
      }

      .loading {
        display: none;
        text-align: center;
        padding: 40px;
      }

      .loading.active {
        display: block;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4caf50;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
        font-size: 14px;
        font-weight: 500;
      }

      .alert.active {
        display: block;
      }

      .alert.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .info-box {
        background: #e8f5e9;
        border-left: 4px solid #4caf50;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
      }

      .info-box strong {
        color: #1b5e20;
        display: block;
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìÑ Generar Nota de Venta</h1>
        <p>Selecciona una cotizaci√≥n y completa los datos adicionales</p>
      </div>

      <div class="content">
        <div id="alertBox" class="alert"></div>

        <form id="formNotaVenta" onsubmit="generarNotaVenta(event)">

          <!-- SELECTOR DE MODO -->
          <div class="section">
            <div class="section-title">Modo de Creaci√≥n</div>

            <div class="radio-group" style="margin-bottom: 20px;">
              <label class="radio-option" style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <input type="radio" name="modoCreacion" value="conCotizacion" checked onchange="cambiarModoCreacion()" style="width: 20px; height: 20px;">
                <div>
                  <span style="font-weight: 600; color: #1b5e20;">üìã Con Cotizaci√≥n</span>
                  <small style="display: block; color: #555; font-size: 12px; margin-top: 4px;">Crear nota de venta desde una cotizaci√≥n existente</small>
                </div>
              </label>

              <label class="radio-option" style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 8px; padding: 15px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                <input type="radio" name="modoCreacion" value="manual" onchange="cambiarModoCreacion()" style="width: 20px; height: 20px;">
                <div>
                  <span style="font-weight: 600; color: #e65100;">‚úèÔ∏è Manual (Sin Cotizaci√≥n)</span>
                  <small style="display: block; color: #555; font-size: 12px; margin-top: 4px;">Crear nota de venta desde cero, sin cotizaci√≥n previa</small>
                </div>
              </label>
            </div>
          </div>

          <!-- SECCI√ìN CON COTIZACI√ìN -->
          <div id="seccionConCotizacion">
            <!-- SELECCI√ìN DE COTIZACI√ìN -->
            <div class="section">
              <div class="section-title">1. Seleccionar Cotizaci√≥n</div>

            <div class="form-group">
              <label for="selectCotizacion">Cotizaci√≥n Base:</label>
              <select id="selectCotizacion" required onchange="cargarDatosCotizacion()">
                <option value="">Selecciona una cotizaci√≥n...</option>
              </select>
            </div>

            <div id="infoCotizacion" class="info-box" style="display:none;">
              <strong>Informaci√≥n de la Cotizaci√≥n:</strong>
              <div id="detallesCotizacion"></div>
            </div>
          </div>

          <!-- PRODUCTOS Y MODO DE VISUALIZACI√ìN -->
          <div class="section">
            <div class="section-title">2. Productos y Modo de Visualizaci√≥n</div>

            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="modoProductos" value="resumido" checked onchange="cambiarModoVisualizacion()">
                <span>Resumido (Total y cantidad de productos)</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="modoProductos" value="desglosado" onchange="cambiarModoVisualizacion()">
                <span>Desglosado (Detalle producto por producto)</span>
              </label>
            </div>

            <div id="vistaProductos" style="display:none; margin-top:15px;">
              <div style="overflow-x: auto; max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                  <thead style="position: sticky; top: 0; background: #1b5e20; color: white; z-index: 10;">
                    <tr>
                      <th style="padding: 10px 8px; text-align: center; border: 1px solid #ddd;">‚úì</th>
                      <th style="padding: 10px 8px; text-align: center; border: 1px solid #ddd;">No.</th>
                      <th style="padding: 10px 8px; text-align: left; border: 1px solid #ddd; min-width: 100px;">C√≥digo</th>
                      <th style="padding: 10px 8px; text-align: left; border: 1px solid #ddd; min-width: 200px;">Descripci√≥n</th>
                      <th style="padding: 10px 8px; text-align: center; border: 1px solid #ddd;">Cant.</th>
                      <th style="padding: 10px 8px; text-align: right; border: 1px solid #ddd;">P.U.</th>
                      <th style="padding: 10px 8px; text-align: center; border: 1px solid #ddd;">% Desc.</th>
                      <th style="padding: 10px 8px; text-align: right; border: 1px solid #ddd;">$ Desc.</th>
                      <th style="padding: 10px 8px; text-align: right; border: 1px solid #ddd;">Importe</th>
                    </tr>
                  </thead>
                  <tbody id="productosTableBody">
                    <!-- Se llenar√° din√°micamente -->
                  </tbody>
                </table>
              </div>
              <div style="margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; font-weight: bold;">
                  <span>Subtotal:</span>
                  <span id="totalSubtotal">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                  <span>IVA (16%):</span>
                  <span id="totalIVA">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 2px solid #1b5e20; font-size: 16px; font-weight: bold; color: #1b5e20;">
                  <span>TOTAL:</span>
                  <span id="totalGeneral">$0.00</span>
                </div>
              </div>
            </div>
          </div>

          <!-- DATOS ADICIONALES DE NOTA DE VENTA -->
          <div class="section">
            <div class="section-title">3. Datos de la Nota de Venta</div>

            <div class="form-group">
              <label for="metodoPago">M√©todo de Pago:</label>
              <select id="metodoPago" required>
                <option value="">Seleccionar...</option>
                <option value="Efectivo">Efectivo</option>
                <option value="Transferencia">Transferencia</option>
                <option value="Tarjeta">Tarjeta de Cr√©dito/D√©bito</option>
                <option value="Cheque">Cheque</option>
                <option value="Mixto">Mixto</option>
              </select>
            </div>

            <div class="form-group">
              <label for="condicionesPago">Condiciones de Pago:</label>
              <select id="condicionesPago" required>
                <option value="">Seleccionar...</option>
                <option value="Contado">Contado</option>
                <option value="50% Anticipo + 50% Contra Entrega">50% Anticipo + 50% Contra Entrega</option>
                <option value="30 d√≠as">30 d√≠as</option>
                <option value="60 d√≠as">60 d√≠as</option>
                <option value="90 d√≠as">90 d√≠as</option>
                <option value="Otro">Otro (especificar en observaciones)</option>
              </select>
            </div>

            <div class="form-group">
              <label for="fechaEntrega">Fecha de Entrega Estimada:</label>
              <input type="text" id="fechaEntrega" placeholder="Ej: 15 de enero de 2025">
            </div>

            <div class="form-group">
              <label for="lugarEntrega">Lugar de Entrega:</label>
              <input type="text" id="lugarEntrega" placeholder="Ej: Guadalajara, Jalisco">
            </div>

            <div class="form-group">
              <label for="observaciones">Observaciones Adicionales:</label>
              <textarea id="observaciones" placeholder="Notas o comentarios adicionales..."></textarea>
            </div>
          </div>

          </div> <!-- Fin seccionConCotizacion -->

          <!-- SECCI√ìN MANUAL (SIN COTIZACI√ìN) -->
          <div id="seccionManual" style="display: none;">

            <!-- DATOS DEL CLIENTE -->
            <div class="section">
              <div class="section-title">1. Datos del Cliente</div>

              <div class="form-group">
                <label for="nombreClienteManual">Nombre del Cliente: *</label>
                <input type="text" id="nombreClienteManual" placeholder="Nombre completo o raz√≥n social">
              </div>

              <div class="form-group">
                <label for="razonSocialManual">Raz√≥n Social:</label>
                <input type="text" id="razonSocialManual" placeholder="Raz√≥n social (si aplica)">
              </div>

              <div class="form-group">
                <label for="contactoManual">Contacto:</label>
                <input type="text" id="contactoManual" placeholder="Tel√©fono o email">
              </div>

              <div class="form-group">
                <label for="domicilioManual">Domicilio:</label>
                <input type="text" id="domicilioManual" placeholder="Direcci√≥n completa">
              </div>
            </div>

            <!-- DATOS DE LA NOTA DE VENTA -->
            <div class="section">
              <div class="section-title">2. Informaci√≥n de la Nota de Venta</div>

              <div class="form-group">
                <label for="proyectoManual">Proyecto / Obra:</label>
                <input type="text" id="proyectoManual" placeholder="Nombre del proyecto u obra">
              </div>

              <div class="form-group">
                <label for="vendedorManual">Vendedor:</label>
                <input type="text" id="vendedorManual" placeholder="Nombre del vendedor">
              </div>
            </div>

            <!-- PRODUCTOS MANUALES -->
            <div class="section">
              <div class="section-title">3. Productos</div>

              <div id="productosManualContainer">
                <!-- Aqu√≠ se agregar√°n productos din√°micamente -->
              </div>

              <button type="button" class="btn btn-secondary" onclick="agregarProductoManual()" style="margin-top: 10px;">
                ‚ûï Agregar Producto
              </button>
            </div>

            <!-- TOTALES MANUAL -->
            <div class="section">
              <div class="section-title">4. Totales</div>

              <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span><strong>Subtotal:</strong></span>
                  <span id="subtotalManual">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span><strong>IVA (16%):</strong></span>
                  <span id="ivaManual">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 18px; color: #1b5e20; border-top: 2px solid #4caf50; padding-top: 8px; margin-top: 8px;">
                  <span><strong>TOTAL:</strong></span>
                  <span id="totalManual">$0.00</span>
                </div>
              </div>
            </div>

            <!-- DATOS ADICIONALES MANUAL -->
            <div class="section">
              <div class="section-title">5. Datos Adicionales</div>

              <div class="form-group">
                <label for="metodoPagoManual">M√©todo de Pago:</label>
                <select id="metodoPagoManual">
                  <option value="Efectivo">Efectivo</option>
                  <option value="Transferencia">Transferencia</option>
                  <option value="Tarjeta">Tarjeta</option>
                  <option value="Cheque">Cheque</option>
                  <option value="Cr√©dito">Cr√©dito</option>
                </select>
              </div>

              <div class="form-group">
                <label for="condicionesPagoManual">Condiciones de Pago:</label>
                <input type="text" id="condicionesPagoManual" placeholder="Ej: Pago al contado, 50% anticipo + 50% contraentrega">
              </div>

              <div class="form-group">
                <label for="fechaEntregaManual">Fecha de Entrega:</label>
                <input type="text" id="fechaEntregaManual" placeholder="Ej: 15 d√≠as h√°biles">
              </div>

              <div class="form-group">
                <label for="lugarEntregaManual">Lugar de Entrega:</label>
                <input type="text" id="lugarEntregaManual" placeholder="Direcci√≥n de entrega">
              </div>

              <div class="form-group">
                <label for="observacionesManual">Observaciones:</label>
                <textarea id="observacionesManual" placeholder="Notas o comentarios adicionales..."></textarea>
              </div>
            </div>

          </div> <!-- Fin seccionManual -->

          <!-- BOT√ìN -->
          <div class="buttons">
            <button type="submit" class="btn btn-primary" id="btnGenerar">
              ‚ú® Generar Nota de Venta
            </button>
          </div>
        </form>

        <div id="loadingGenerar" class="loading">
          <div class="spinner"></div>
          <p>Generando Nota de Venta...</p>
        </div>
      </div>
    </div>

    <script>
      var cotizacionesDisponibles = [];
      var cotizacionSeleccionada = null;

      // Cargar cotizaciones al iniciar
      window.addEventListener('load', function() {
        cargarCotizaciones();
      });

      function cargarCotizaciones() {
        google.script.run
          .withSuccessHandler(function(cotizaciones) {
            cotizacionesDisponibles = cotizaciones;
            var select = document.getElementById('selectCotizacion');

            if (!cotizaciones || cotizaciones.length === 0) {
              mostrarAlerta('No hay cotizaciones disponibles. Genera una cotizaci√≥n primero.', 'error');
              return;
            }

            cotizaciones.forEach(function(cot) {
              var option = document.createElement('option');
              option.value = cot.folio;
              option.textContent = 'Folio ' + cot.folio + ' - ' + cot.cliente + ' (' + cot.proyecto + ')';
              select.appendChild(option);
            });
          })
          .withFailureHandler(function(error) {
            mostrarAlerta('Error al cargar cotizaciones: ' + error.message, 'error');
          })
          .obtenerCotizacionesDisponibles();
      }

      function cargarDatosCotizacion() {
        var folio = document.getElementById('selectCotizacion').value;

        if (!folio) {
          document.getElementById('infoCotizacion').style.display = 'none';
          document.getElementById('vistaProductos').style.display = 'none';
          cotizacionSeleccionada = null;
          return;
        }

        cotizacionSeleccionada = cotizacionesDisponibles.find(function(c) {
          return c.folio == folio;
        });

        if (cotizacionSeleccionada) {
          // Mostrar informaci√≥n de la cotizaci√≥n
          var detalles = document.getElementById('detallesCotizacion');
          detalles.innerHTML =
            '<strong>Cliente:</strong> ' + cotizacionSeleccionada.cliente + '<br>' +
            '<strong>Proyecto:</strong> ' + cotizacionSeleccionada.proyecto + '<br>' +
            '<strong>Total:</strong> $' + cotizacionSeleccionada.total.toLocaleString('es-MX', {minimumFractionDigits: 2}) + '<br>' +
            '<strong>Productos:</strong> ' + cotizacionSeleccionada.productos.length + ' items';

          document.getElementById('infoCotizacion').style.display = 'block';

          // Mostrar productos
          mostrarProductos();
        }
      }

      function cambiarModoVisualizacion() {
        mostrarProductos();
      }

      function mostrarProductos() {
        if (!cotizacionSeleccionada) return;

        var modoProductos = document.querySelector('input[name="modoProductos"]:checked').value;
        document.getElementById('vistaProductos').style.display = 'block';
        var tbody = document.getElementById('productosTableBody');
        tbody.innerHTML = '';

        if (modoProductos === 'resumido') {
          // MODO RESUMIDO: Una sola partida con descripci√≥n editable
          var tr = document.createElement('tr');
          tr.style.backgroundColor = '#ffffff';

          // Calcular total de todos los productos
          var totalCantidad = cotizacionSeleccionada.productos.length;
          var subtotalTotal = 0;

          cotizacionSeleccionada.productos.forEach(function(prod) {
            subtotalTotal += prod.importe || (prod.precioUnitario * prod.cantidad);
          });

          // Construir descripci√≥n formal (igual que en el PDF)
          var idProyecto = cotizacionSeleccionada.datosCotizacion.idObra || cotizacionSeleccionada.datosCotizacion.proyecto || "el proyecto";
          var domicilio = cotizacionSeleccionada.datosCliente.domicilioEntrega || "";
          var vendedor = cotizacionSeleccionada.datosCotizacion.vendedor || "";
          var folioCotizacion = cotizacionSeleccionada.folio || "";

          var descripcionFormal = "Pago correspondiente a";
          if (folioCotizacion) {
            descripcionFormal += " la cotizaci√≥n folio " + folioCotizacion;
          }
          if (idProyecto) {
            descripcionFormal += " del proyecto \"" + idProyecto + "\"";
          }
          if (domicilio) {
            descripcionFormal += ", instalado en " + domicilio;
          }
          if (vendedor) {
            descripcionFormal += ". Atendido por: " + vendedor;
          }
          descripcionFormal += ".";

          tr.innerHTML =
            '<td style="padding: 8px; text-align: center; border: 1px solid #ddd;">' +
              '<input type="checkbox" class="producto-checkbox-resumido" checked disabled>' +
            '</td>' +
            '<td style="padding: 8px; text-align: center; border: 1px solid #ddd;">1</td>' +
            '<td style="padding: 8px; border: 1px solid #ddd;">' +
              '<input type="text" id="codigo-resumido" value="VARIOS" style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">' +
            '</td>' +
            '<td style="padding: 8px; border: 1px solid #ddd;">' +
              '<textarea id="descripcion-resumida" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 80px; font-family: inherit; font-size: 13px; resize: vertical;">' + descripcionFormal + '</textarea>' +
            '</td>' +
            '<td style="padding: 8px; text-align: center; border: 1px solid #ddd;">' + totalCantidad + '</td>' +
            '<td style="padding: 8px; text-align: right; border: 1px solid #ddd;" id="pu-resumido">$' + subtotalTotal.toLocaleString('es-MX', {minimumFractionDigits: 2}) + '</td>' +
            '<td style="padding: 8px; text-align: center; border: 1px solid #ddd;">' +
              '<input type="number" id="descuento-resumido" value="0" min="0" max="100" step="0.1" onchange="calcularDescuentoResumido()" style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">' +
            '</td>' +
            '<td style="padding: 8px; text-align: right; border: 1px solid #ddd;" id="desc-pesos-resumido">$0.00</td>' +
            '<td style="padding: 8px; text-align: right; border: 1px solid #ddd; font-weight: bold;" id="importe-resumido">$' + subtotalTotal.toLocaleString('es-MX', {minimumFractionDigits: 2}) + '</td>';

          tbody.appendChild(tr);

          // Guardar el subtotal para el c√°lculo de descuento
          window.subtotalResumido = subtotalTotal;

        } else {
          // MODO DESGLOSADO: Tabla completa con todos los productos
          cotizacionSeleccionada.productos.forEach(function(prod, index) {
            var tr = document.createElement('tr');
            tr.style.backgroundColor = index % 2 === 0 ? '#ffffff' : '#f9f9f9';

            var cantidad = prod.cantidad || 1;
            var precioUnitario = prod.precioUnitario || 0;
            var descuentoPorcentaje = prod.descuentoPorcentaje || 0;
            var descuentoPesos = prod.descuentoPesos || 0;
            var importe = prod.importe || (precioUnitario * cantidad);

            tr.innerHTML =
              '<td style="padding: 8px; text-align: center; border: 1px solid #ddd;">' +
                '<input type="checkbox" class="producto-checkbox" checked data-index="' + index + '">' +
              '</td>' +
              '<td style="padding: 8px; text-align: center; border: 1px solid #ddd;">' + (index + 1) + '</td>' +
              '<td style="padding: 8px; border: 1px solid #ddd;">' +
                '<input type="text" class="producto-codigo" value="' + (prod.codigo || '') + '" data-index="' + index + '" style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">' +
              '</td>' +
              '<td style="padding: 8px; border: 1px solid #ddd;">' + (prod.descripcion || '').substring(0, 60) + (prod.descripcion && prod.descripcion.length > 60 ? '...' : '') + '</td>' +
              '<td style="padding: 8px; text-align: center; border: 1px solid #ddd;">' + cantidad + '</td>' +
              '<td style="padding: 8px; text-align: right; border: 1px solid #ddd;">$' + precioUnitario.toLocaleString('es-MX', {minimumFractionDigits: 2}) + '</td>' +
              '<td style="padding: 8px; text-align: center; border: 1px solid #ddd;">' +
                '<input type="number" class="producto-descuento" value="' + descuentoPorcentaje + '" min="0" max="100" step="0.1" data-index="' + index + '" onchange="calcularDescuento(' + index + ')" style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">' +
              '</td>' +
              '<td style="padding: 8px; text-align: right; border: 1px solid #ddd;" id="desc-pesos-' + index + '">$' + descuentoPesos.toLocaleString('es-MX', {minimumFractionDigits: 2}) + '</td>' +
              '<td style="padding: 8px; text-align: right; border: 1px solid #ddd; font-weight: bold;" id="importe-' + index + '">$' + importe.toLocaleString('es-MX', {minimumFractionDigits: 2}) + '</td>';

            tbody.appendChild(tr);
          });

          // Event listener para recalcular cuando se marcan/desmarcan checkboxes
          document.querySelectorAll('.producto-checkbox').forEach(function(checkbox) {
            checkbox.addEventListener('change', calcularTotales);
          });
        }

        calcularTotales();
      }

      function calcularDescuento(index) {
        var prod = cotizacionSeleccionada.productos[index];
        var descuentoPorcentaje = parseFloat(document.querySelector('.producto-descuento[data-index="' + index + '"]').value) || 0;

        var cantidad = prod.cantidad || 1;
        var precioUnitario = prod.precioUnitario || 0;
        var subtotalProducto = precioUnitario * cantidad;
        var descuentoPesos = (subtotalProducto * descuentoPorcentaje) / 100;
        var importe = subtotalProducto - descuentoPesos;

        // Actualizar en el objeto
        prod.descuentoPorcentaje = descuentoPorcentaje;
        prod.descuentoPesos = descuentoPesos;
        prod.importe = importe;

        // Actualizar en la interfaz
        document.getElementById('desc-pesos-' + index).textContent = '$' + descuentoPesos.toLocaleString('es-MX', {minimumFractionDigits: 2});
        document.getElementById('importe-' + index).textContent = '$' + importe.toLocaleString('es-MX', {minimumFractionDigits: 2});

        calcularTotales();
      }

      function calcularDescuentoResumido() {
        var descuentoPorcentaje = parseFloat(document.getElementById('descuento-resumido').value) || 0;
        var subtotal = window.subtotalResumido || 0;
        var descuentoPesos = (subtotal * descuentoPorcentaje) / 100;
        var importe = subtotal - descuentoPesos;

        // Actualizar en la interfaz
        document.getElementById('desc-pesos-resumido').textContent = '$' + descuentoPesos.toLocaleString('es-MX', {minimumFractionDigits: 2});
        document.getElementById('importe-resumido').textContent = '$' + importe.toLocaleString('es-MX', {minimumFractionDigits: 2});

        // Guardar para usar al generar
        window.descuentoPorcentajeResumido = descuentoPorcentaje;
        window.descuentoPesosResumido = descuentoPesos;
        window.importeResumido = importe;

        calcularTotales();
      }

      function calcularTotales() {
        var modoProductos = document.querySelector('input[name="modoProductos"]:checked').value;
        var subtotal = 0;

        if (modoProductos === 'resumido') {
          // En modo resumido, usar el importe con descuento
          subtotal = window.importeResumido || window.subtotalResumido || 0;
        } else {
          // En modo desglosado, sumar productos seleccionados
          var checkboxes = document.querySelectorAll('.producto-checkbox:checked');
          checkboxes.forEach(function(checkbox) {
            var index = parseInt(checkbox.dataset.index);
            var prod = cotizacionSeleccionada.productos[index];
            subtotal += prod.importe || 0;
          });
        }

        var iva = subtotal * 0.16;
        var total = subtotal + iva;

        document.getElementById('totalSubtotal').textContent = '$' + subtotal.toLocaleString('es-MX', {minimumFractionDigits: 2});
        document.getElementById('totalIVA').textContent = '$' + iva.toLocaleString('es-MX', {minimumFractionDigits: 2});
        document.getElementById('totalGeneral').textContent = '$' + total.toLocaleString('es-MX', {minimumFractionDigits: 2});
      }

      // Variables para productos manuales
      var productosManual = [];
      var contadorProductosManual = 0;

      // Cambiar entre modo Con Cotizaci√≥n y Manual
      function cambiarModoCreacion() {
        var modoSeleccionado = document.querySelector('input[name="modoCreacion"]:checked').value;

        if (modoSeleccionado === 'conCotizacion') {
          document.getElementById('seccionConCotizacion').style.display = 'block';
          document.getElementById('seccionManual').style.display = 'none';
          // Hacer campos de cotizaci√≥n required
          document.getElementById('selectCotizacion').setAttribute('required', 'required');
          // Quitar required de campos manuales
          document.getElementById('nombreClienteManual').removeAttribute('required');
        } else {
          document.getElementById('seccionConCotizacion').style.display = 'none';
          document.getElementById('seccionManual').style.display = 'block';
          // Hacer campos manuales required
          document.getElementById('nombreClienteManual').setAttribute('required', 'required');
          // Quitar required de cotizaci√≥n
          document.getElementById('selectCotizacion').removeAttribute('required');
          // Agregar primer producto autom√°ticamente
          if (productosManual.length === 0) {
            agregarProductoManual();
          }
        }
      }

      // Agregar producto manual
      function agregarProductoManual() {
        var index = contadorProductosManual++;
        var container = document.getElementById('productosManualContainer');

        var productoDiv = document.createElement('div');
        productoDiv.id = 'productoManual' + index;
        productoDiv.style.cssText = 'background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e0e0e0;';

        productoDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <strong style="color: #1b5e20;">Producto ${index + 1}</strong>
            <button type="button" onclick="eliminarProductoManual(${index})" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚ùå Eliminar</button>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <div>
              <label style="font-size: 13px; font-weight: 500; margin-bottom: 4px; display: block;">C√≥digo:</label>
              <input type="text" id="codigo${index}" placeholder="C√≥digo del producto" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 13px; font-weight: 500; margin-bottom: 4px; display: block;">Cantidad: *</label>
              <input type="number" id="cantidad${index}" placeholder="1" value="1" min="1" required onchange="calcularImporteProductoManual(${index})" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>

          <div style="margin-bottom: 10px;">
            <label style="font-size: 13px; font-weight: 500; margin-bottom: 4px; display: block;">Descripci√≥n: *</label>
            <textarea id="descripcion${index}" placeholder="Descripci√≥n del producto" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 60px;"></textarea>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
            <div>
              <label style="font-size: 13px; font-weight: 500; margin-bottom: 4px; display: block;">Precio Unitario: *</label>
              <input type="number" id="precioUnitario${index}" placeholder="0.00" step="0.01" min="0" required onchange="calcularImporteProductoManual(${index})" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 13px; font-weight: 500; margin-bottom: 4px; display: block;">% Desc:</label>
              <input type="number" id="descuentoPorcentaje${index}" placeholder="0" step="0.0000001" min="0" max="100" value="0" onchange="calcularImporteProductoManual(${index})" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 13px; font-weight: 500; margin-bottom: 4px; display: block;">Importe:</label>
              <input type="text" id="importe${index}" placeholder="$0.00" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5; font-weight: 600;">
            </div>
          </div>
        `;

        container.appendChild(productoDiv);
      }

      // Eliminar producto manual
      function eliminarProductoManual(index) {
        var productoDiv = document.getElementById('productoManual' + index);
        if (productoDiv) {
          productoDiv.remove();
          calcularTotalesManual();
        }
      }

      // Calcular importe de un producto manual
      function calcularImporteProductoManual(index) {
        var cantidad = parseFloat(document.getElementById('cantidad' + index).value) || 0;
        var precioUnitario = parseFloat(document.getElementById('precioUnitario' + index).value) || 0;
        var descuentoPorcentaje = parseFloat(document.getElementById('descuentoPorcentaje' + index).value) || 0;

        var importeBase = cantidad * precioUnitario;
        var descuento = importeBase * (descuentoPorcentaje / 100);
        var importe = importeBase - descuento;

        document.getElementById('importe' + index).value = '$' + importe.toFixed(2);

        calcularTotalesManual();
      }

      // Calcular totales del modo manual
      function calcularTotalesManual() {
        var subtotal = 0;

        for (var i = 0; i < contadorProductosManual; i++) {
          var cantidadInput = document.getElementById('cantidad' + i);
          if (!cantidadInput) continue; // Producto eliminado

          var cantidad = parseFloat(cantidadInput.value) || 0;
          var precioUnitario = parseFloat(document.getElementById('precioUnitario' + i).value) || 0;
          var descuentoPorcentaje = parseFloat(document.getElementById('descuentoPorcentaje' + i).value) || 0;

          var importeBase = cantidad * precioUnitario;
          var descuento = importeBase * (descuentoPorcentaje / 100);
          var importe = importeBase - descuento;

          subtotal += importe;
        }

        var iva = subtotal * 0.16;
        var total = subtotal + iva;

        document.getElementById('subtotalManual').textContent = '$' + subtotal.toFixed(2);
        document.getElementById('ivaManual').textContent = '$' + iva.toFixed(2);
        document.getElementById('totalManual').textContent = '$' + total.toFixed(2);
      }

      function generarNotaVenta(event) {
        event.preventDefault();

        var modoCreacion = document.querySelector('input[name="modoCreacion"]:checked').value;

        // MODO CON COTIZACI√ìN
        if (modoCreacion === 'conCotizacion') {
          if (!cotizacionSeleccionada) {
            mostrarAlerta('Selecciona una cotizaci√≥n primero', 'error');
            return;
          }

        var modoProductos = document.querySelector('input[name="modoProductos"]:checked').value;
        var metodoPago = document.getElementById('metodoPago').value;
        var condicionesPago = document.getElementById('condicionesPago').value;
        var fechaEntrega = document.getElementById('fechaEntrega').value;
        var lugarEntrega = document.getElementById('lugarEntrega').value;
        var observaciones = document.getElementById('observaciones').value;

        // Recopilar productos seg√∫n el modo
        var productosSeleccionados = [];
        var subtotal = 0;

        if (modoProductos === 'resumido') {
          // MODO RESUMIDO: Crear una partida √∫nica con la descripci√≥n editada
          var codigoResumido = document.getElementById('codigo-resumido').value;
          var descripcionResumida = document.getElementById('descripcion-resumida').value;
          var descuentoPorcentaje = window.descuentoPorcentajeResumido || 0;
          var descuentoPesos = window.descuentoPesosResumido || 0;
          var importeFinal = window.importeResumido || 0;

          // Calcular subtotal base de todos los productos
          var totalCantidad = cotizacionSeleccionada.productos.length;
          var subtotalBase = 0;
          cotizacionSeleccionada.productos.forEach(function(prod) {
            subtotalBase += prod.importe || (prod.precioUnitario * prod.cantidad);
          });

          // Si no hay descuento aplicado, usar el subtotal base
          if (importeFinal === 0) {
            importeFinal = subtotalBase;
          }

          subtotal = importeFinal;

          var productoResumido = {
            codigo: codigoResumido,
            descripcion: descripcionResumida,
            cantidad: totalCantidad,
            precioUnitario: subtotalBase,
            descuentoPorcentaje: descuentoPorcentaje,
            descuentoPesos: descuentoPesos,
            importe: importeFinal
          };

          productosSeleccionados.push(productoResumido);

        } else {
          // MODO DESGLOSADO: Productos seleccionados con c√≥digos editados
          var checkboxes = document.querySelectorAll('.producto-checkbox:checked');

          checkboxes.forEach(function(checkbox) {
            var index = parseInt(checkbox.dataset.index);
            var prod = cotizacionSeleccionada.productos[index];
            var codigoInput = document.querySelector('.producto-codigo[data-index="' + index + '"]');

            var productoFinal = {
              codigo: codigoInput ? codigoInput.value : prod.codigo,
              descripcion: prod.descripcion,
              cantidad: prod.cantidad,
              precioUnitario: prod.precioUnitario,
              descuentoPorcentaje: prod.descuentoPorcentaje || 0,
              descuentoPesos: prod.descuentoPesos || 0,
              importe: prod.importe
            };

            productosSeleccionados.push(productoFinal);
            subtotal += productoFinal.importe;
          });
        }

        if (productosSeleccionados.length === 0) {
          mostrarAlerta('Selecciona al menos un producto', 'error');
          return;
        }

        // Calcular totales
        var iva = subtotal * 0.16;
        var total = subtotal + iva;

        // Agregar el folio de cotizaci√≥n al objeto datosCotizacion
        var datosCotizacionCompletos = Object.assign({}, cotizacionSeleccionada.datosCotizacion);
        datosCotizacionCompletos.folioCotizacion = cotizacionSeleccionada.folio;

        var datosNotaVenta = {
          folioCotizacion: cotizacionSeleccionada.folio,
          modoProductos: modoProductos,
          metodoPago: metodoPago,
          condicionesPago: condicionesPago,
          fechaEntrega: fechaEntrega,
          lugarEntrega: lugarEntrega,
          observaciones: observaciones,
          datosCliente: cotizacionSeleccionada.datosCliente,
          datosCotizacion: datosCotizacionCompletos,
          productos: productosSeleccionados,
          modoPrecioCerrado: cotizacionSeleccionada.modoPrecioCerrado || false,  // Indicar si es Modo B
          totales: {
            subtotal: subtotal,
            iva: iva,
            total: total
          }
        };

        // Mostrar loading y enviar
        document.getElementById('formNotaVenta').style.display = 'none';
        document.getElementById('loadingGenerar').classList.add('active');

        google.script.run
          .withSuccessHandler(function(resultado) {
            document.getElementById('loadingGenerar').classList.remove('active');

            if (resultado.exito) {
              mostrarAlerta('‚úÖ Nota de Venta generada exitosamente! Folio: ' + resultado.folio, 'success');

              setTimeout(function() {
                window.open(resultado.url, '_blank');
                location.reload();
              }, 2000);
            } else {
              mostrarAlerta('‚ùå ' + resultado.mensaje, 'error');
              document.getElementById('formNotaVenta').style.display = 'block';
            }
          })
          .withFailureHandler(function(error) {
            document.getElementById('loadingGenerar').classList.remove('active');
            document.getElementById('formNotaVenta').style.display = 'block';
            mostrarAlerta('‚ùå Error: ' + error.message, 'error');
          })
          .generarPDFNotaVenta(datosNotaVenta);

        } else {
          // MODO MANUAL (SIN COTIZACI√ìN)
          var nombreCliente = document.getElementById('nombreClienteManual').value;
          var razonSocial = document.getElementById('razonSocialManual').value;
          var contacto = document.getElementById('contactoManual').value;
          var domicilio = document.getElementById('domicilioManual').value;
          var proyecto = document.getElementById('proyectoManual').value;
          var vendedor = document.getElementById('vendedorManual').value;
          var metodoPagoManual = document.getElementById('metodoPagoManual').value;
          var condicionesPagoManual = document.getElementById('condicionesPagoManual').value;
          var fechaEntregaManual = document.getElementById('fechaEntregaManual').value;
          var lugarEntregaManual = document.getElementById('lugarEntregaManual').value;
          var observacionesManual = document.getElementById('observacionesManual').value;

          // Recopilar productos manuales
          var productosManualRecopilados = [];
          var subtotalManual = 0;

          for (var i = 0; i < contadorProductosManual; i++) {
            var cantidadInput = document.getElementById('cantidad' + i);
            if (!cantidadInput) continue; // Producto eliminado

            var codigo = document.getElementById('codigo' + i).value || 'SUM E INS';
            var descripcion = document.getElementById('descripcion' + i).value;
            var cantidad = parseFloat(cantidadInput.value) || 0;
            var precioUnitario = parseFloat(document.getElementById('precioUnitario' + i).value) || 0;
            var descuentoPorcentaje = parseFloat(document.getElementById('descuentoPorcentaje' + i).value) || 0;

            if (!descripcion || cantidad <= 0 || precioUnitario <= 0) {
              mostrarAlerta('Completa todos los campos requeridos de los productos', 'error');
              return;
            }

            var importeBase = cantidad * precioUnitario;
            var descuento = importeBase * (descuentoPorcentaje / 100);
            var importe = importeBase - descuento;

            productosManualRecopilados.push({
              codigo: codigo,
              descripcion: descripcion,
              cantidad: cantidad,
              precioUnitario: precioUnitario,
              descuentoPorcentaje: descuentoPorcentaje,
              descuentoPesos: descuento,
              importe: importe
            });

            subtotalManual += importe;
          }

          if (productosManualRecopilados.length === 0) {
            mostrarAlerta('Agrega al menos un producto', 'error');
            return;
          }

          var ivaManualCalc = subtotalManual * 0.16;
          var totalManualCalc = subtotalManual + ivaManualCalc;

          var datosNotaVentaManual = {
            modoCreacion: 'manual',
            modoProductos: 'desglosado',
            metodoPago: metodoPagoManual,
            condicionesPago: condicionesPagoManual,
            fechaEntrega: fechaEntregaManual,
            lugarEntrega: lugarEntregaManual,
            observaciones: observacionesManual,
            datosCliente: {
              nombre: nombreCliente,
              razonSocial: razonSocial,
              contacto: contacto,
              domicilio: domicilio
            },
            datosCotizacion: {
              proyecto: proyecto,
              vendedor: vendedor
            },
            productos: productosManualRecopilados,
            modoPrecioCerrado: false,
            totales: {
              subtotal: subtotalManual,
              iva: ivaManualCalc,
              total: totalManualCalc
            }
          };

          // Mostrar loading y enviar
          document.getElementById('formNotaVenta').style.display = 'none';
          document.getElementById('loadingGenerar').classList.add('active');

          google.script.run
            .withSuccessHandler(function(resultado) {
              document.getElementById('loadingGenerar').classList.remove('active');

              if (resultado.exito) {
                mostrarAlerta('‚úÖ Nota de Venta generada exitosamente! Folio: ' + resultado.folio, 'success');

                setTimeout(function() {
                  window.open(resultado.url, '_blank');
                  location.reload();
                }, 2000);
              } else {
                mostrarAlerta('‚ùå ' + resultado.mensaje, 'error');
                document.getElementById('formNotaVenta').style.display = 'block';
              }
            })
            .withFailureHandler(function(error) {
              document.getElementById('loadingGenerar').classList.remove('active');
              document.getElementById('formNotaVenta').style.display = 'block';
              mostrarAlerta('‚ùå Error: ' + error.message, 'error');
            })
            .generarPDFNotaVenta(datosNotaVentaManual);
        }
      }

      function mostrarAlerta(mensaje, tipo) {
        var alertBox = document.getElementById('alertBox');
        alertBox.textContent = mensaje;
        alertBox.className = 'alert ' + tipo + ' active';

        setTimeout(function() {
          alertBox.classList.remove('active');
        }, 5000);
      }
    </script>
  </body>
</html>
